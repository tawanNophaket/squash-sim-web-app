<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>โปรแกรมจำลองการตีลูกสควอช - 3มิติ</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Anuphan:wght@300;400;500;600;700&display=swap"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.0.1/chartjs-plugin-annotation.min.js"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
      /* เพิ่ม CSS ในส่วนนี้ */
      .result-detail {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-top: var(--spacing-xs);
      }

      .checkbox-control input[type="checkbox"] {
        width: 20px;
        height: 20px;
        margin-right: var(--spacing-sm);
      }

      .checkbox-control label {
        display: flex;
        align-items: center;
        margin-bottom: 0;
        font-weight: 500;
        color: var(--text-primary);
        cursor: pointer;
      }

      .help-text {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-top: var(--spacing-sm);
        padding: var(--spacing-sm);
        background-color: rgba(0, 0, 0, 0.1);
        border-radius: var(--radius-sm);
        border-left: 3px solid var(--primary-dark);
      }

      .help-text i {
        color: var(--primary);
        margin-right: var(--spacing-xs);
      }

      .highlight {
        color: var(--primary-light);
        font-weight: 600;
      }

      button:disabled {
        background-color: #555 !important;
        color: #999 !important;
        cursor: not-allowed !important;
        box-shadow: none !important;
        transform: none !important;
        opacity: 0.7;
      }

      .target-inputs {
        display: flex;
        gap: var(--spacing-md);
      }
      .target-inputs .control-group {
        flex: 1;
      }
      .chart-container-grid {
        display: grid;
        grid-template-columns: 1fr; /* Default to 1 column for mobile */
        gap: var(--spacing-md);
      }

      @media (min-width: 992px) {
        /* Adjust breakpoint as needed for wider screens */
        .chart-container-grid {
          grid-template-columns: 1fr 1fr; /* 2 columns for wider screens */
        }
      }

      /* CSS จาก compare_results.html */
      .comparison-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
      }
      .result-section {
        background-color: var(--surface-card);
        padding: var(--spacing-md);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-sm);
      }
      .result-section h3 {
        color: var(--primary);
        margin-bottom: var(--spacing-sm);
        border-bottom: 1px solid var(--border-color);
        padding-bottom: var(--spacing-xs);
      }
      .comparison-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: var(--spacing-sm);
      }
      .comparison-table th,
      .comparison-table td {
        border: 1px solid var(--border-color);
        padding: var(--spacing-sm);
        text-align: left;
      }
      .comparison-table th {
        background-color: var(--surface-header);
        color: var(--text-secondary);
      }
      /* สิ้นสุด CSS จาก compare_results.html */
    </style>
  </head>
  <body>
    <div id="loading-screen" class="loading-screen">
      <h1 class="loading-title">โปรเเกรมจำลองการตีลูกสควอซ กลุ่ม 11</h1>
      <div class="loading-spinner"></div>
    </div>

    <div id="notification" class="notification">
      <div class="notification-icon"></div>
      <div class="notification-content">
        <div class="notification-message" id="notification-message"></div>
      </div>
    </div>

    <div class="content-wrapper">
      <div class="container">
        <h1>
          <i class="fas fa-bullseye" style="margin-right: 10px"></i>
          โปรแกรมจำลองการตีลูกสควอช (3D Squash Ball Striker Simulator)
        </h1>

        <div class="tabs">
          <button class="tab-btn active" onclick="openTab('simulator')">
            <i class="fas fa-sliders-h"></i> เครื่องจำลอง
          </button>
          <button class="tab-btn" onclick="openTab('results')">
            <i class="fas fa-chart-line"></i> ผลลัพธ์
          </button>
          <button class="tab-btn" onclick="openTab('field')">
            <i class="fas fa-map-marked-alt"></i> สนาม
          </button>
          <button class="tab-btn" onclick="openTab('compare')">
            <i class="fas fa-balance-scale"></i> เปรียบเทียบผล
          </button>
          <button class="tab-btn" onclick="openTab('settings')">
            <i class="fas fa-cog"></i> ตั้งค่า
          </button>
        </div>

        <div id="simulator" class="tab-content active">
          <div class="card">
            <h2><i class="fas fa-sliders-h"></i> ตั้งค่าหลัก</h2>

            <div class="control-group">
              <label for="release-height">ความสูงในการปล่อยลูก (m)</label>
              <select id="release-height" class="select-control">
                <option value="1.0">1.0m (ต่ำ)</option>
                <option value="1.5">1.5m (ปานกลาง)</option>
                <option value="2.0" selected>2.0m (สูง)</option>
              </select>
            </div>

            <div class="control-group">
              <label for="strike-height">ความสูงในการตี (m)</label>
              <div class="control-slider">
                <input
                  type="range"
                  id="strike-height"
                  min="0.01"
                  max="0.5"
                  step="0.01"
                  value="0.35"
                />
                <span id="height-value" class="value">0.35m</span>
              </div>
            </div>

            <div class="control-group">
              <label for="strike-angle-elevation"
                >มุมเงยในการตี (แนวตั้ง) (°)</label
              >
              <div class="control-slider">
                <input
                  type="range"
                  id="strike-angle-elevation"
                  min="10"
                  max="80"
                  step="0.1"
                  value="45"
                />
                <span id="angle-elevation-value" class="value">45.0°</span>
              </div>
            </div>

            <div class="control-group">
              <label for="strike-azimuth-angle"
                >มุมทิศในการตี (แนวนอน) (°)</label
              >
              <div class="control-slider">
                <input
                  type="range"
                  id="strike-azimuth-angle"
                  min="-45"
                  max="45"
                  step="0.1"
                  value="0"
                />
                <span id="angle-azimuth-value" class="value">0.0°</span>
              </div>
            </div>

            <div class="control-group">
              <label for="strike-velocity">ความเร็วในการตี (m/s)</label>
              <div class="control-slider">
                <input
                  type="range"
                  id="strike-velocity"
                  min="1"
                  max="20"
                  step="0.1"
                  value="5.25"
                />
                <span id="velocity-value" class="value">5.25 m/s</span>
              </div>
            </div>

            <div class="control-group">
              <div class="checkbox-control">
                <input type="checkbox" id="ideal-comparison" />
                <label for="ideal-comparison"
                  >แสดงการเปรียบเทียบวิถีในอุดมคติ</label
                >
              </div>
            </div>
          </div>

          <div class="card">
            <h2>
              <i class="fas fa-crosshairs"></i> พิกัดเป้าหมาย (Target
              Coordinates)
            </h2>
            <div class="target-inputs">
              <div class="control-group">
                <label for="target-x">เป้าหมาย X (m)</label>
                <input
                  type="number"
                  id="target-x"
                  step="0.01"
                  value="0.0"
                  class="input-control"
                />
              </div>
              <div class="control-group">
                <label for="target-z">เป้าหมาย Z (m, ด้านหน้า)</label>
                <input
                  type="number"
                  id="target-z"
                  step="0.01"
                  value="1.7"
                  class="input-control"
                />
              </div>
            </div>
            <div class="zone-indicator" style="margin-top: var(--spacing-sm)">
              <span>โซนเป้าหมาย (จาก X,Z): </span>
              <span id="indicator-zone-2d" class="zone-badge">โซน ?</span>
            </div>
          </div>

          <div class="card">
            <h2><i class="fas fa-cogs"></i> ตั้งค่าการปรับให้เหมาะสม</h2>
            <div class="control-group">
              <div class="checkbox-control">
                <input type="checkbox" id="fix-elevation-angle" />
                <label for="fix-elevation-angle">ตรึงค่ามุมเงยปัจจุบัน</label>
              </div>
            </div>
            <div class="control-group">
              <div class="checkbox-control">
                <input type="checkbox" id="fix-azimuth-angle" />
                <label for="fix-azimuth-angle">ตรึงค่ามุมทิศปัจจุบัน</label>
              </div>
            </div>
            <div class="control-group">
              <div class="checkbox-control">
                <input type="checkbox" id="fix-velocity" />
                <label for="fix-velocity">ตรึงค่าความเร็วปัจจุบัน</label>
              </div>
            </div>
            <p class="help-text">
              <i class="fas fa-info-circle"></i> หากไม่เลือกตัวเลือกใดเลย
              ระบบจะปรับพารามิเตอร์ทั้งสามให้เหมาะสม (มุมเงย, มุมทิศ, ความเร็ว)
            </p>
          </div>

          <button
            id="start-btn"
            class="btn-primary btn-full pulse"
            onclick="startSimulation()"
          >
            <i class="fas fa-play"></i>เริ่มการจำลอง
          </button>

          <button
            id="optimize-btn"
            class="btn-accent btn-full"
            onclick="optimizeSettings()"
          >
            <i class="fas fa-magic"></i>ค้นหาค่าที่เหมาะสมที่สุด
          </button>

          <button
            id="reset-btn"
            class="btn-secondary btn-full"
            onclick="resetSimulation()"
          >
            <i class="fas fa-redo"></i>รีเซ็ตการตั้งค่าทั้งหมด
          </button>
        </div>

        <div id="results" class="tab-content">
          <div class="card">
            <h2><i class="fas fa-chart-line"></i> ผลลัพธ์การจำลอง</h2>
            <div class="results-grid">
              <div class="result-card">
                <div class="result-label">
                  ตำแหน่งตกกระทบ X (Landing Position X)
                </div>
                <div id="landing-position-x" class="result-value">0.00 m</div>
              </div>
              <div class="result-card">
                <div class="result-label">
                  ตำแหน่งตกกระทบ Z (Landing Position Z, Forward)
                </div>
                <div id="landing-position-z" class="result-value">0.00 m</div>
              </div>
              <div class="result-card">
                <div class="result-label">
                  ระยะห่างแนวรัศมี (Radial Distance)
                </div>
                <div id="landing-distance-radial" class="result-value">
                  0.00 m
                </div>
              </div>
              <div class="result-card">
                <div class="result-label">
                  โซนเป้าหมายที่โดน (Target Zone Hit)
                </div>
                <div id="target-zone-hit" class="result-value">
                  ไม่มี (None)
                </div>
              </div>
              <div class="result-card">
                <div class="result-label">เวลาที่ใช้ในการตี (Strike Time)</div>
                <div id="strike-time" class="result-value">0.00 s</div>
              </div>
            </div>
            <div
              class="results-grid ideal-result-group"
              style="display: none; margin-top: var(--spacing-sm)"
            >
              <div class="result-card">
                <div class="result-label">
                  ตำแหน่งตกกระทบ X (อุดมคติ) (Ideal Landing X)
                </div>
                <div id="ideal-landing-x" class="result-value">0.00 m</div>
              </div>
              <div class="result-card">
                <div class="result-label">
                  ตำแหน่งตกกระทบ Z (อุดมคติ) (Ideal Landing Z)
                </div>
                <div id="ideal-landing-z" class="result-value">0.00 m</div>
              </div>
            </div>
          </div>

          <div class="card">
            <h2>
              <i class="fas fa-project-diagram"></i> การแสดงผลวิถีโคจร
              (Trajectory Visualizations)
            </h2>
            <div class="chart-container-grid">
              <div class="chart-container">
                <h3
                  style="text-align: center; margin-bottom: var(--spacing-sm)"
                >
                  มุมมองด้านข้าง (Side View, Z-Y Projection)
                </h3>
                <canvas id="trajectory-chart-side-view"></canvas>
              </div>
              <div class="chart-container">
                <h3
                  style="text-align: center; margin-bottom: var(--spacing-sm)"
                >
                  มุมมองด้านบน (Top-Down View, X-Z Projection)
                </h3>
                <canvas id="trajectory-chart-top-view"></canvas>
              </div>
            </div>
          </div>

          <div
            id="optimal-params-display"
            style="display: none; margin-top: 16px"
          >
            <div class="card">
              <h3>
                <i class="fas fa-bullseye"></i>
                พารามิเตอร์ที่เหมาะสมที่สุด
              </h3>

              <!-- Section for Read-only System Optimized Values -->
              <h4 style="margin-top: var(--spacing-sm); margin-bottom: var(--spacing-xs); color: var(--text-secondary);">
                <i class="fas fa-cogs"></i> ผลลัพธ์จากระบบ (ค่าตั้งต้นสำหรับการปรับ):
              </h4>
              <div class="results-grid">
                <div class="result-card">
                  <div class="result-label">มุมเงย (จากระบบ)</div>
                  <div id="system-optimal-elevation-value" class="result-value">N/A</div>
                </div>
                <div class="result-card">
                  <div class="result-label">มุมทิศ (จากระบบ)</div>
                  <div id="system-optimal-azimuth-value" class="result-value">N/A</div>
                </div>
                <div class="result-card">
                  <div class="result-label">ความเร็ว (จากระบบ)</div>
                  <div id="system-optimal-velocity-value" class="result-value">N/A</div>
                </div>
              </div>

              <hr style="margin: var(--spacing-md) 0;">

              <!-- Section for User Adjustable Inputs -->
              <h4 style="margin-top: var(--spacing-sm); margin-bottom: var(--spacing-xs); color: var(--text-secondary);">
                <i class="fas fa-edit"></i> ปรับค่าพารามิเตอร์เพื่อทดลอง (อ้างอิงจากผลระบบ ±5%):
              </h4>
              <div class="results-grid">
                <div class="result-card">
                  <label for="optimized-elevation-angle-input" class="result-label">มุมเงย (ปรับค่า)</label>
                  <input type="number" id="optimized-elevation-angle-input" class="input-control optimized-param-input" step="0.1">
                  <div class="result-detail">
                    ช่วงที่แนะนำ: <span id="optimized-elevation-angle-range">N/A</span>
                  </div>
                </div>
                <div class="result-card">
                  <label for="optimized-azimuth-angle-input" class="result-label">มุมทิศ (ปรับค่า)</label>
                  <input type="number" id="optimized-azimuth-angle-input" class="input-control optimized-param-input" step="0.1">
                  <div class="result-detail">
                    ช่วงที่แนะนำ: <span id="optimized-azimuth-angle-range">N/A</span>
                  </div>
                </div>
                <div class="result-card">
                  <label for="optimized-velocity-input" class="result-label">ความเร็ว (ปรับค่า)</label>
                  <input type="number" id="optimized-velocity-input" class="input-control optimized-param-input" step="0.01">
                  <div class="result-detail">
                    ช่วงที่แนะนำ: <span id="optimized-velocity-range">N/A</span>
                  </div>
                </div>
              </div>
              <div style="margin-top: var(--spacing-md);">
                <button id="simulate-with-optimal-inputs-btn" class="btn-secondary btn-full">
                  <i class="fas fa-play-circle"></i> ใช้ค่าที่ปรับแล้วนี้จำลอง
                </button>
              </div>
            </div>
          </div>
        </div>

        <div id="field" class="tab-content">
          <div class="card">
            <h2><i class="fas fa-th"></i> รูปแบบสนาม & การกำหนดเป้าหมาย</h2>
            <div class="control-group">
              <label for="field-type"
                >เลือกรูปแบบสนาม (Select Field Layout)</label
              >
              <select id="field-type" onchange="handleFieldTypeChange()">
                <option value="standard" selected>
                  มาตรฐาน (Standard, 1D Radial)
                </option>
                <option value="extra1">
                  ขยายระยะ (Extended Range, 1D Radial)
                </option>
                <option value="extra2">สนามทำมุม (Angled Field, 2D X-Z)</option>
                <option value="real1">สนามจริง 1 (3x2m, มีรูปจริง)</option>
              </select>
            </div>
            <div class="chart-container" style="height: 400px">
              <canvas id="field-chart-2d"></canvas>
            </div>
            <div
              id="field-info-text"
              class="help-text"
              style="margin-top: 16px"
            >
              <p>
                <i class="fas fa-info-circle"></i>
                สำหรับสนาม 2มิติ (เช่น Extra2),
                คลิกบนแผนภูมิเพื่อตั้งค่าเป้าหมาย X,Z. สำหรับสนาม 1มิติ,
                โซนจะเป็นแนวรัศมี (For 2D fields (e.g., Extra2), click on the
                chart to set Target X,Z. For 1D fields, zones are radial.)
              </p>
            </div>
          </div>
        </div>

        <div id="compare" class="tab-content">
          <div class="card">
            <h2>
              <i class="fas fa-balance-scale" style="margin-right: 10px"></i>
              เปรียบเทียบผลการทดลองและผลการจำลอง (Compare Experimental &
              Simulation Results)
            </h2>
            <div class="comparison-grid">
              <div class="result-section sim-params-section">
                <h3>
                  <i class="fas fa-cogs"></i> พารามิเตอร์การจำลอง (เปรียบเทียบ)
                  (Simulation Parameters - Compare)
                </h3>
                <div class="control-group">
                  <label for="comp-release-height"
                    >ความสูงในการปล่อยลูก (m) (Release Height (m))</label
                  >
                  <input
                    type="number"
                    id="comp-release-height"
                    value="2.0"
                    step="0.1"
                    class="input-control"
                  />
                </div>
                <div class="control-group">
                  <label for="comp-strike-height"
                    >ความสูงในการตี (m) (Strike Height (m))</label
                  >
                  <input
                    type="number"
                    id="comp-strike-height"
                    value="0.35"
                    step="0.01"
                    class="input-control"
                  />
                </div>
                <div class="control-group">
                  <label for="comp-strike-angle-elevation"
                    >มุมเงยในการตี (°) (Strike Elevation Angle (°))</label
                  >
                  <input
                    type="number"
                    id="comp-strike-angle-elevation"
                    value="45"
                    step="0.1"
                    class="input-control"
                  />
                </div>
                <div class="control-group">
                  <label for="comp-strike-azimuth-angle"
                    >มุมทิศในการตี (°) (Strike Azimuth Angle (°))</label
                  >
                  <input
                    type="number"
                    id="comp-strike-azimuth-angle"
                    value="0"
                    step="0.1"
                    class="input-control"
                  />
                </div>
                <div class="control-group">
                  <label for="comp-strike-velocity"
                    >ความเร็วในการตี (m/s) (Strike Velocity (m/s))</label
                  >
                  <input
                    type="number"
                    id="comp-strike-velocity"
                    value="5.25"
                    step="0.1"
                    class="input-control"
                  />
                </div>
                <button id="run-sim-compare-btn" class="btn-primary">
                  <i class="fas fa-play"></i> เริ่มการจำลอง (เพื่อเปรียบเทียบ)
                  (Run Simulation - Compare)
                </button>
              </div>

              <div class="result-section sim-results-section">
                <h3>
                  <i class="fas fa-chart-line"></i> ผลลัพธ์จากการจำลอง
                  (เปรียบเทียบ) (Simulation Results - Compare)
                </h3>
                <table class="comparison-table">
                  <tr>
                    <th>รายการ (Item)</th>
                    <th>ค่า (Value)</th>
                  </tr>
                  <tr>
                    <td>ตำแหน่งตกกระทบ X (จำลอง) (Simulated Landing X)</td>
                    <td id="compare-sim-landing-x">-</td>
                  </tr>
                  <tr>
                    <td>ตำแหน่งตกกระทบ Z (จำลอง) (Simulated Landing Z)</td>
                    <td id="compare-sim-landing-z">-</td>
                  </tr>
                  <tr>
                    <td>ระยะทางแนวรัศมี (จำลอง) (Simulated Radial Dist.)</td>
                    <td id="compare-sim-radial-dist">-</td>
                  </tr>
                  <tr>
                    <td>เวลาที่ใช้ (จำลอง) (Simulated Time)</td>
                    <td id="compare-sim-strike-time">-</td>
                  </tr>
                </table>
              </div>

              <div class="result-section actual-input-section">
                <h3>
                  <i class="fas fa-edit"></i> ป้อนผลการทดลองจริง (เปรียบเทียบ)
                  (Enter Actual Experimental Results - Compare)
                </h3>
                <div class="control-group">
                  <label for="compare-actual-landing-x"
                    >ตำแหน่งตกกระทบ X จริง (m) (Actual Landing X (m))</label
                  >
                  <input
                    type="number"
                    id="compare-actual-landing-x"
                    step="0.01"
                    class="input-control"
                  />
                </div>
                <div class="control-group">
                  <label for="compare-actual-landing-z"
                    >ตำแหน่งตกกระทบ Z จริง (m) (Actual Landing Z (m))</label
                  >
                  <input
                    type="number"
                    id="compare-actual-landing-z"
                    step="0.01"
                    class="input-control"
                  />
                </div>
                <div class="control-group">
                  <label for="compare-actual-strike-time"
                    >เวลาตกกระทบจริง (s) (Actual Strike Time (s))</label
                  >
                  <input
                    type="number"
                    id="compare-actual-strike-time"
                    step="0.001"
                    class="input-control"
                  />
                </div>
                <button id="compare-results-btn" class="btn-accent" disabled>
                  <i class="fas fa-balance-scale"></i> เปรียบเทียบผลลัพธ์
                  (Compare Results)
                </button>
              </div>

              <div class="result-section comparison-results-section">
                <h3>
                  <i class="fas fa-equals"></i> ผลการเปรียบเทียบ (Comparison
                  Results)
                </h3>
                <table class="comparison-table">
                  <tr>
                    <th>รายการ (Item)</th>
                    <th>ค่า (Value)</th>
                  </tr>
                  <tr>
                    <td>
                      ความแตกต่าง X (จำลอง - จริง) (Delta X (Sim - Actual))
                    </td>
                    <td id="compare-delta-x">-</td>
                  </tr>
                  <tr>
                    <td>
                      ความแตกต่าง Z (จำลอง - จริง) (Delta Z (Sim - Actual))
                    </td>
                    <td id="compare-delta-z">-</td>
                  </tr>
                  <tr>
                    <td>ระยะคลาดเคลื่อนรวม (Total Error Distance)</td>
                    <td id="compare-error-distance">-</td>
                  </tr>
                  <tr>
                    <td>ผลต่างของเวลา (จำลอง - จริง) (s) (Delta Time (Sim - Actual) (s))</td>
                    <td id="compare-delta-time">-</td>
                  </tr>
                  <tr>
                    <td>ความคลาดเคลื่อน X (%) (Percentage Error X (%))</td>
                    <td id="compare-percentage-error-x">-</td>
                  </tr>
                  <tr>
                    <td>ความคลาดเคลื่อน Z (%) (Percentage Error Z (%))</td>
                    <td id="compare-percentage-error-z">-</td>
                  </tr>
                </table>
              </div>
            </div>

            <div style="text-align: center; margin-top: var(--spacing-lg)">
              <button
                id="export-csv-compare-btn"
                class="btn-secondary btn-full"
                disabled
              >
                <i class="fas fa-file-csv"></i> Export ผลลัพธ์เปรียบเทียบเป็น
                CSV (Export Comparison as CSV)
              </button>
            </div>
          </div>
        </div>
        <!-- สิ้นสุดเนื้อหา Tab compare -->

        <div id="settings" class="tab-content">
          <div class="card">
            <h2>
              <i class="fas fa-ruler-combined"></i> พารามิเตอร์สนามแบบกำหนดเอง
              (ส่วนใหญ่สำหรับสนาม 1มิติ) (Custom Field Parameters - mainly for
              1D fields)
            </h2>
            <p class="help-text">
              การตั้งค่าเหล่านี้ส่วนใหญ่ใช้กับสนามแนวรัศมี 1มิติ 'มาตรฐาน' หรือ
              'ขยายระยะ' หากคุณกำหนดให้เป็น 'กำหนดเอง' ส่วน 'สนามทำมุม (2มิติ)'
              จะใช้ข้อมูลโซนที่กำหนดไว้ล่วงหน้า (These settings mostly apply to
              1D radial fields like 'Standard' or 'Extended Range'. The 'Angled
              Field (2D)' uses predefined zone data.)
            </p>
            <div class="control-group">
              <label for="min-distance"
                >ระยะรัศมีต่ำสุด (m) (Min. Radial Distance (m))</label
              >
              <input
                type="number"
                id="min-distance"
                min="0.1"
                max="10"
                step="0.01"
                value="0.75"
                class="input-control"
              />
            </div>
            <div class="control-group">
              <label for="max-distance"
                >ระยะรัศมีสูงสุด (m) (Max. Radial Distance (m))</label
              >
              <input
                type="number"
                id="max-distance"
                min="0.1"
                max="10"
                step="0.01"
                value="2.65"
                class="input-control"
              />
            </div>
            <div class="control-group">
              <label for="zone-width"
                >ความกว้างโซนแนวรัศมี (m) (Radial Zone Width (m))</label
              >
              <input
                type="number"
                id="zone-width"
                min="0.1"
                max="2"
                step="0.01"
                value="0.38"
                class="input-control"
              />
            </div>
          </div>

          <div class="card">
            <h2>
              <i class="fas fa-atom"></i> ตั้งค่าฟิสิกส์ขั้นสูง (Advanced
              Physics Settings)
            </h2>
            <div class="control-group">
              <label for="gravity">แรงโน้มถ่วง (m/s²) (Gravity (m/s²))</label>
              <input
                type="number"
                id="gravity"
                min="1"
                max="20"
                step="0.01"
                value="9.81"
                class="input-control"
              />
            </div>
            <div class="control-group">
              <label for="ball-mass">มวลลูกบอล (kg) (Ball Mass (kg))</label>
              <input
                type="number"
                id="ball-mass"
                min="0.01"
                max="0.1"
                step="0.001"
                value="0.024"
                class="input-control"
              />
            </div>
            <div class="control-group">
              <label for="air-density"
                >ความหนาแน่นอากาศ (kg/m³) (Air Density (kg/m³))</label
              >
              <input
                type="number"
                id="air-density"
                min="0.1"
                max="5"
                step="0.001"
                value="1.225"
                class="input-control"
              />
            </div>
            <div class="control-group">
              <label for="drag-coefficient"
                >สัมประสิทธิ์แรงต้าน (Drag Coefficient)</label
              >
              <input
                type="number"
                id="drag-coefficient"
                min="0.1"
                max="2"
                step="0.01"
                value="0.5"
                class="input-control"
              />
            </div>
            <div class="control-group">
              <label for="elasticity"
                >ค่าความยืดหยุ่น (การคืนตัวของลูกบอล) (Elasticity - Ball
                Restitution)</label
              >
              <input
                type="number"
                id="elasticity"
                min="0.1"
                max="1"
                step="0.01"
                value="0.4"
                class="input-control"
              />
            </div>
          </div>
        </div>
        <!-- สิ้นสุดเนื้อหา Tab settings -->
      </div>
      <!-- ปิด .container หลัก -->

      <div class="mobile-nav">
        <button class="nav-btn active" onclick="openTab('simulator')">
          <i class="fas fa-sliders-h"></i>
          <span>เครื่องจำลอง</span>
        </button>
        <button class="nav-btn" onclick="openTab('results')">
          <i class="fas fa-chart-line"></i>
          <span>ผลลัพธ์</span>
        </button>
        <button class="nav-btn" onclick="openTab('field')">
          <i class="fas fa-map-marked-alt"></i>
          <span>สนาม</span>
        </button>
        <button class="nav-btn" onclick="openTab('compare')">
          <i class="fas fa-balance-scale"></i>
          <span>เปรียบเทียบผล</span>
        </button>
        <button class="nav-btn" onclick="openTab('settings')">
          <i class="fas fa-cog"></i>
          <span>ตั้งค่า</span>
        </button>
      </div>
    </div>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script>
      window.addEventListener("load", function () {
        setTimeout(function () {
          document.getElementById("loading-screen").classList.add("fade-out");
        }, 1500);
      });

      let compareTabJsInitialized = false; // Flag to track initialization

      function initializeCompareTab() {
        const runSimCompareBtn = document.getElementById("run-sim-compare-btn");
        const compareResultsBtn = document.getElementById(
          "compare-results-btn"
        );
        const exportCsvCompareBtn = document.getElementById(
          "export-csv-compare-btn"
        );

        if (!runSimCompareBtn || !compareResultsBtn || !exportCsvCompareBtn) {
          // Elements not found, likely not on the compare tab or DOM not fully ready.
          // console.warn("Compare tab elements not found during initialization attempt.");
          return;
        }

        // Load last simulation parameters from general simulation into compare tab inputs
        // This part can be run every time the tab is initialized/shown to refresh defaults.
        const lastMainSimParams = JSON.parse(
          localStorage.getItem("lastSimulationParams")
        );
        if (lastMainSimParams) {
          if (document.getElementById("comp-release-height"))
            document.getElementById("comp-release-height").value =
              lastMainSimParams.release_height || 2.0;
          if (document.getElementById("comp-strike-height"))
            document.getElementById("comp-strike-height").value =
              lastMainSimParams.strike_height || 0.35;
          if (document.getElementById("comp-strike-angle-elevation"))
            document.getElementById("comp-strike-angle-elevation").value =
              lastMainSimParams.strike_angle_elevation || 45;
          if (document.getElementById("comp-strike-azimuth-angle"))
            document.getElementById("comp-strike-azimuth-angle").value =
              lastMainSimParams.strike_azimuth_angle || 0;
          if (document.getElementById("comp-strike-velocity"))
            document.getElementById("comp-strike-velocity").value =
              lastMainSimParams.strike_velocity || 5.25;
        }
        // Ensure physics settings are loaded/defaulted for the compare tab
        // This can also be run each time to ensure consistency if physics settings change in another tab.
        getPhysicsSettingsForCompareTab();

        if (compareTabJsInitialized) {
          // console.log("Compare tab JS already initialized. Skipping event listener setup.");
          return; // Listeners already attached
        }
        // console.log("Initializing Compare tab JS and attaching event listeners.");

        let simParamsCompare = {};
        let simResultsCompare = {};
        let actualResultsCompare = {};

        function getPhysicsSettingsForCompareTab() {
          const physics = {
            gravity:
              parseFloat(localStorage.getItem("physics_gravity")) || 9.81,
            ball_mass:
              parseFloat(localStorage.getItem("physics_ball_mass")) || 0.024,
            air_density:
              parseFloat(localStorage.getItem("physics_air_density")) || 1.225,
            drag_coefficient:
              parseFloat(localStorage.getItem("physics_drag_coefficient")) ||
              0.5,
            elasticity:
              parseFloat(localStorage.getItem("physics_elasticity")) || 0.4,
          };
          localStorage.setItem("physics_gravity", physics.gravity);
          localStorage.setItem("physics_ball_mass", physics.ball_mass);
          localStorage.setItem("physics_air_density", physics.air_density);
          localStorage.setItem(
            "physics_drag_coefficient",
            physics.drag_coefficient
          );
          localStorage.setItem("physics_elasticity", physics.elasticity);
          return physics;
        }

        const safe = (v, d = 0) => (typeof v === "number" && !isNaN(v) ? v : d);

        runSimCompareBtn.addEventListener("click", function () {
          simParamsCompare = {
            release_height: parseFloat(
              document.getElementById("comp-release-height").value
            ),
            strike_height: parseFloat(
              document.getElementById("comp-strike-height").value
            ),
            strike_angle_elevation: parseFloat(
              document.getElementById("comp-strike-angle-elevation").value
            ),
            strike_azimuth_angle: parseFloat(
              document.getElementById("comp-strike-azimuth-angle").value
            ),
            strike_velocity: parseFloat(
              document.getElementById("comp-strike-velocity").value
            ),
            show_ideal: false,
            physics: getPhysicsSettingsForCompareTab(),
          };
          showCustomMessage("กำลังจำลองผล (เพื่อเปรียบเทียบ)...", "info", 2000);
          fetch("/api/calculate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(simParamsCompare),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.error) {
                showCustomMessage(
                  "เกิดข้อผิดพลาดในการจำลอง (เปรียบเทียบ): " + data.error,
                  "error"
                );
                simResultsCompare = {};
                updateSimResultsTableForCompareTab(simResultsCompare);
                compareResultsBtn.disabled = true;
                exportCsvCompareBtn.disabled = true;
              } else {
                simResultsCompare = {
                  landing_position_x: data.landing_position_x,
                  landing_position_z: data.landing_position_z,
                  landing_distance_radial: data.landing_distance_radial,
                  strike_time: data.strike_time,
                };
                updateSimResultsTableForCompareTab(simResultsCompare);
                compareResultsBtn.disabled = false;
                exportCsvCompareBtn.disabled = true;
                document.getElementById("compare-delta-x").textContent = "-";
                document.getElementById("compare-delta-z").textContent = "-";
                document.getElementById("compare-error-distance").textContent =
                  "-";
                showCustomMessage(
                  "การจำลอง (เปรียบเทียบ) เสร็จสิ้น",
                  "success"
                );
              }
            })
            .catch((error) => {
              showCustomMessage(
                "เกิดข้อผิดพลาดในการเชื่อมต่อ (เปรียบเทียบ): " + error,
                "error"
              );
              simResultsCompare = {};
              updateSimResultsTableForCompareTab(simResultsCompare);
              compareResultsBtn.disabled = true;
              exportCsvCompareBtn.disabled = true;
            });
        });

        function updateSimResultsTableForCompareTab(results) {
          document.getElementById("compare-sim-landing-x").textContent =
            results.landing_position_x !== undefined
              ? safe(results.landing_position_x).toFixed(3) + " m"
              : "-";
          document.getElementById("compare-sim-landing-z").textContent =
            results.landing_position_z !== undefined
              ? safe(results.landing_position_z).toFixed(3) + " m"
              : "-";
          document.getElementById("compare-sim-radial-dist").textContent =
            results.landing_distance_radial !== undefined
              ? safe(results.landing_distance_radial).toFixed(3) + " m"
              : "-";
          document.getElementById("compare-sim-strike-time").textContent =
            results.strike_time !== undefined
              ? safe(results.strike_time).toFixed(3) + " s"
              : "-";
        }

        compareResultsBtn.addEventListener("click", function () {
          const actualX = parseFloat(
            document.getElementById("compare-actual-landing-x").value
          );
          const actualZ = parseFloat(
            document.getElementById("compare-actual-landing-z").value
          );
          const actualTime = parseFloat(
            document.getElementById("compare-actual-strike-time").value
          );

          if (isNaN(actualX) || isNaN(actualZ)) {
            showCustomMessage(
              "กรุณาป้อนผลการทดลองจริง X และ Z (เปรียบเทียบ) ให้ถูกต้อง",
              "warning"
            );
            // ไม่จำเป็นต้อง disable exportCsvCompareBtn ที่นี่ เพราะอาจมีข้อมูลเวลาที่ถูกต้อง
            return;
          }
          if (
            simResultsCompare.landing_position_x === undefined ||
            simResultsCompare.landing_position_z === undefined
            // ไม่จำเป็นต้องเช็ค simResultsCompare.strike_time ที่นี่ เพราะการเปรียบเทียบ X, Z สามารถทำได้แม้ไม่มีเวลาจำลอง
          ) {
            showCustomMessage(
              "กรุณาทำการจำลองผล (เปรียบเทียบ) เพื่อให้มีค่า Landing X, Z ก่อนเปรียบเทียบ",
              "warning"
            );
            exportCsvCompareBtn.disabled = true; // ถ้าไม่มีผลจำลอง X,Z ก็ export ไม่ได้
            return;
          }

          actualResultsCompare = {
            landing_position_x: actualX,
            landing_position_z: actualZ,
            strike_time: !isNaN(actualTime) ? actualTime : undefined, // เก็บเฉพาะเมื่อเป็นตัวเลข
          };

          const simX = simResultsCompare.landing_position_x;
          const simZ = simResultsCompare.landing_position_z;
          const simTime = simResultsCompare.strike_time;

          const deltaX = simX - actualX;
          const deltaZ = simZ - actualZ;
          const errorDistance = Math.sqrt(deltaX ** 2 + deltaZ ** 2);

          document.getElementById("compare-delta-x").textContent =
            safe(deltaX).toFixed(3) + " m";
          document.getElementById("compare-delta-z").textContent =
            safe(deltaZ).toFixed(3) + " m";
          document.getElementById("compare-error-distance").textContent =
            safe(errorDistance).toFixed(3) + " m";

          let percentageErrorX = "-";
          if (!isNaN(actualX) && actualX !== 0) {
            percentageErrorX = ((deltaX / actualX) * 100).toFixed(2) + " %";
          } else if (!isNaN(actualX) && actualX === 0 && !isNaN(simX) && simX !== 0) {
            percentageErrorX = "∞ % (Actual is 0)"; // หรือ N/A
          }
          document.getElementById("compare-percentage-error-x").textContent = percentageErrorX;

          let percentageErrorZ = "-";
          if (!isNaN(actualZ) && actualZ !== 0) {
            percentageErrorZ = ((deltaZ / actualZ) * 100).toFixed(2) + " %";
          } else if (!isNaN(actualZ) && actualZ === 0 && !isNaN(simZ) && simZ !== 0) {
            percentageErrorZ = "∞ % (Actual is 0)"; // หรือ N/A
          }
          document.getElementById("compare-percentage-error-z").textContent = percentageErrorZ;
          
          let deltaTime = "-";
          if (simTime !== undefined && actualResultsCompare.strike_time !== undefined) {
            deltaTime = safe(simTime - actualResultsCompare.strike_time).toFixed(3) + " s";
          }
          document.getElementById("compare-delta-time").textContent = deltaTime;


          exportCsvCompareBtn.disabled = false; // เปิดใช้งานปุ่ม Export เมื่อมีการเปรียบเทียบสำเร็จ
          showCustomMessage(
            "การเปรียบเทียบผลลัพธ์ (เปรียบเทียบ) เสร็จสิ้น",
            "info"
          );
        });

        exportCsvCompareBtn.addEventListener("click", function () {
          if (
            Object.keys(simParamsCompare).length === 0 ||
            Object.keys(simResultsCompare).length === 0 || // ต้องมีผลจำลอง
            (isNaN(parseFloat(document.getElementById("compare-actual-landing-x").value)) || // ต้องมีผลจริง X
             isNaN(parseFloat(document.getElementById("compare-actual-landing-z").value))) // ต้องมีผลจริง Z
          ) {
            showCustomMessage(
              "ข้อมูลไม่ครบถ้วนสำหรับการ Export (เปรียบเทียบ): กรุณาทำการจำลองและป้อนค่า X, Z จริง",
              "warning"
            );
            return;
          }
          // actualResultsCompare จะถูก set ใน compareResultsBtn.addEventListener
          // ดังนั้น ตรวจสอบอีกครั้งว่ามีค่าที่จำเป็นหรือไม่
          const currentActualX = parseFloat(document.getElementById("compare-actual-landing-x").value);
          const currentActualZ = parseFloat(document.getElementById("compare-actual-landing-z").value);
          const currentActualTime = parseFloat(document.getElementById("compare-actual-strike-time").value);

          // อัปเดต actualResultsCompare ให้เป็นค่าล่าสุดก่อน export
          actualResultsCompare = {
            landing_position_x: currentActualX,
            landing_position_z: currentActualZ,
            strike_time: !isNaN(currentActualTime) ? currentActualTime : undefined,
          };


          let csvContent = "data:text/csv;charset=utf-8,";
          csvContent += "Parameter,Simulated Value,Actual Value,Difference,Percentage Error\\r\\n";
          csvContent +=
            "Release Height (m)," +
            simParamsCompare.release_height +
            ",N/A,N/A,N/A\\r\\n";
          csvContent +=
            "Strike Height (m)," +
            simParamsCompare.strike_height +
            ",N/A,N/A,N/A\\r\\n";
          csvContent +=
            "Strike Angle Elevation (°)," +
            simParamsCompare.strike_angle_elevation +
            ",N/A,N/A,N/A\\r\\n";
          csvContent +=
            "Strike Azimuth Angle (°)," +
            simParamsCompare.strike_azimuth_angle +
            ",N/A,N/A,N/A\\r\\n";
          csvContent +=
            "Strike Velocity (m/s)," +
            simParamsCompare.strike_velocity +
            ",N/A,N/A,N/A\\r\\n";
          csvContent +=
            "Gravity (m/s²)," +
            (simParamsCompare.physics ? simParamsCompare.physics.gravity : 'N/A') +
            ",N/A,N/A,N/A\\r\\n";
          csvContent +=
            "Ball Mass (kg)," +
            (simParamsCompare.physics ? simParamsCompare.physics.ball_mass : 'N/A') +
            ",N/A,N/A,N/A\\r\\n";
          csvContent +=
            "Air Density (kg/m³)," +
            (simParamsCompare.physics ? simParamsCompare.physics.air_density : 'N/A') +
            ",N/A,N/A,N/A\\r\\n";
          csvContent +=
            "Drag Coefficient," +
            (simParamsCompare.physics ? simParamsCompare.physics.drag_coefficient : 'N/A') +
            ",N/A,N/A,N/A\\r\\n";
          csvContent +=
            "Elasticity," +
            (simParamsCompare.physics ? simParamsCompare.physics.elasticity : 'N/A') +
            ",N/A,N/A,N/A\\r\\n";

          const simX = simResultsCompare.landing_position_x;
          const simZ = simResultsCompare.landing_position_z;
          const simTime = simResultsCompare.strike_time;

          const actX = actualResultsCompare.landing_position_x;
          const actZ = actualResultsCompare.landing_position_z;
          const actTime = actualResultsCompare.strike_time;

          let diffX_val = (simX !== undefined && actX !== undefined && !isNaN(actX)) ? safe(simX - actX).toFixed(3) : "";
          let percErrorX_val = "";
          if (simX !== undefined && actX !== undefined && !isNaN(actX)) {
            if (actX !== 0) {
              percErrorX_val = (( (simX - actX) / actX) * 100).toFixed(2) + "%";
            } else if (simX !== 0) {
              percErrorX_val = "Inf";
            } else {
              percErrorX_val = "0.00%"; // Sim and Actual are both 0
            }
          }

          csvContent +=
            "Landing X (m)," +
            (simX !== undefined ? safe(simX).toFixed(3) : "") +
            "," +
            (actX !== undefined && !isNaN(actX) ? safe(actX).toFixed(3) : "") +
            "," +
            diffX_val +
            "," +
            percErrorX_val +
            "\\r\\n";

          let diffZ_val = (simZ !== undefined && actZ !== undefined && !isNaN(actZ)) ? safe(simZ - actZ).toFixed(3) : "";
          let percErrorZ_val = "";
           if (simZ !== undefined && actZ !== undefined && !isNaN(actZ)) {
            if (actZ !== 0) {
              percErrorZ_val = (((simZ - actZ) / actZ) * 100).toFixed(2) + "%";
            } else if (simZ !== 0) {
              percErrorZ_val = "Inf";
            } else {
               percErrorZ_val = "0.00%";
            }
          }

          csvContent +=
            "Landing Z (m)," +
            (simZ !== undefined ? safe(simZ).toFixed(3) : "") +
            "," +
            (actZ !== undefined && !isNaN(actZ) ? safe(actZ).toFixed(3) : "") +
            "," +
            diffZ_val +
            "," +
            percErrorZ_val +
            "\\r\\n";

          csvContent +=
            "Radial Distance (m)," +
            (simResultsCompare.landing_distance_radial !== undefined
              ? safe(simResultsCompare.landing_distance_radial).toFixed(3)
              : "") +
            ",N/A,N/A,N/A\\r\\n"; // Actual Radial and Diff Radial not directly asked for, keep as N/A

          let diffTime_val = (simTime !== undefined && actTime !== undefined && !isNaN(actTime)) ? safe(simTime - actTime).toFixed(3) : "";
          csvContent +=
            "Strike Time (s)," +
            (simTime !== undefined ? safe(simTime).toFixed(3) : "") +
            "," +
            (actTime !== undefined && !isNaN(actTime) ? safe(actTime).toFixed(3) : "") +
            "," +
            diffTime_val +
            ",N/A\\r\\n"; // Percentage error for time usually not standard, keep as N/A

          const encodedUri = encodeURI(csvContent);
          const link = document.createElement("a");
          link.setAttribute("href", encodedUri);
          link.setAttribute("download", "comparison_results.csv");
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          showCustomMessage("Export CSV (เปรียบเทียบ) สำเร็จ", "success");
        });

        compareTabJsInitialized = true; // Set flag to true after attaching listeners
      }

      // Call initialization for compare tab on DOMContentLoaded.
      document.addEventListener("DOMContentLoaded", function () {
        // Initialize other tabs/main functionalities if they also have specific JS initializations here
        // For now, specifically calling initializeCompareTab if needed (e.g. if it's the default active tab)
        // However, the openTab override handles initialization when switching to the 'compare' tab.
        // Let's ensure it's called if 'compare' is the initial active tab (though unlikely by default)
        if (
          document.getElementById("compare") &&
          document.getElementById("compare").classList.contains("active")
        ) {
          initializeCompareTab();
        }
      });
    </script>
  </body>
</html>


